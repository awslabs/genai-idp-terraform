# GitLab CI/CD Pipeline for Terraform IDP Accelerator
# All terraform-lint issues have been resolved across all modules
stages:
  - validate
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  TF_VERSION: "1.6.6"
  TFLINT_VERSION: "0.56.0"
  TFSEC_VERSION: "1.28.5"
  CHECKOV_VERSION: "3.2.255"

cache:
  paths:
    - .pip-cache/
    - .terraform/
    - .tflint.d/

# Common setup for Terraform jobs
.setup-terraform:
  image: 
    name: hashicorp/terraform:$TF_VERSION
    entrypoint: [""]
  before_script:
    - apk add --no-cache curl unzip
    - terraform --version

# Common setup for documentation jobs
.setup-docs:
  image: python:3.11-slim
  before_script:
    - apt-get update && apt-get install -y git
    - pip install --upgrade pip
    - pip install -r docs/requirements.txt

# Terraform Format Check
terraform-fmt:
  extends: .setup-terraform
  stage: validate
  script:
    - echo "Checking Terraform formatting..."
    - terraform fmt -check -recursive -diff
    - echo "✅ Terraform formatting is correct"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.tf"
        - "**/*.tfvars"
    - if: '$CI_COMMIT_BRANCH == "main"'

# Terraform Validation
terraform-validate:
  extends: .setup-terraform
  stage: validate
  script:
    - echo "Validating Terraform configurations in modules..."
    - |
      # Validate all modules (excluding examples and sources)
      for dir in modules/*/; do
        if [ -f "$dir/main.tf" ] || [ -f "$dir/versions.tf" ]; then
          echo "Validating $dir"
          cd "$dir"
          terraform init -backend=false
          terraform validate
          cd - > /dev/null
        fi
      done
    - echo "✅ All Terraform module configurations are valid"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "modules/**/*.tf"
        - "modules/**/*.tfvars"
    - if: '$CI_COMMIT_BRANCH == "main"'

# TFLint - Terraform Linting
terraform-lint:
  image: 
    name: hashicorp/terraform:$TF_VERSION
    entrypoint: [""]
  stage: validate
  allow_failure: true
  before_script:
    - apk add --no-cache curl unzip bash
    - terraform --version
    # Install tflint directly
    - curl -sSLo tflint.zip https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/tflint_linux_amd64.zip
    - unzip tflint.zip
    - chmod +x tflint
    - mv tflint /usr/local/bin/
    - tflint --version
    # Initialize tflint plugins
    - tflint --init
  script:
    - echo "Running TFLint checks recursively on modules..."
    - |
      # Use tflint --recursive to scan all modules at once
      # Start from modules directory to exclude examples and sources
      cd modules
      tflint --recursive \
        --config=$CI_PROJECT_DIR/.tflint.hcl \
        --format=compact
    - echo "✅ TFLint checks completed successfully"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "modules/**/*.tf"
        - "modules/**/*.tfvars"
        - ".tflint.hcl"
    - if: '$CI_COMMIT_BRANCH == "main"'

# TFSec - Terraform Security Scanning
terraform-security:
  image: alpine:latest
  stage: validate
  allow_failure: true
  before_script:
    - apk add --no-cache curl bash
    # Install tfsec directly
    - curl -sSLo tfsec https://github.com/aquasecurity/tfsec/releases/download/v${TFSEC_VERSION}/tfsec-linux-amd64
    - chmod +x tfsec
    - mv tfsec /usr/local/bin/
    - tfsec --version
  script:
    - echo "Running TFSec security checks (excluding examples/ and sources/)..."
    - |
      # Run tfsec with configuration
      tfsec . \
        --config-file .tfsec/config.yml \
        --format json \
        --out tfsec-report.json \
        --soft-fail
    - |
      # Also generate human-readable output
      tfsec . \
        --config-file .tfsec/config.yml \
        --format default \
        --soft-fail
    - echo "✅ TFSec security scan completed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "modules/**/*.tf"
        - "modules/**/*.tfvars"
        - ".tfsec/**/*"
    - if: '$CI_COMMIT_BRANCH == "main"'

# Checkov - Infrastructure as Code Security Scanning
terraform-checkov:
  stage: validate
  allow_failure: true
  image:
    name: bridgecrew/checkov:latest
    entrypoint:
      - '/usr/bin/env'
      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
  script:
    - checkov -d . | tee checkov.test.xml
  artifacts:
    reports:
      junit: "checkov.test.xml"
    paths:
      - "checkov.test.xml"
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.tf"
        - "modules/**/*.tf"
        - "modules/**/*.tfvars"
        - ".checkov.yml"
    - if: '$CI_COMMIT_BRANCH == "main"'

# Terraform Documentation Check
terraform-docs:
  image: 
    name: hashicorp/terraform:$TF_VERSION
    entrypoint: [""]
  stage: validate
  before_script:
    - apk add --no-cache curl
    - terraform --version
    # Install terraform-docs
    - curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.17.0/terraform-docs-v0.17.0-$(uname)-amd64.tar.gz
    - tar -xzf terraform-docs.tar.gz
    - chmod +x terraform-docs
    - mv terraform-docs /usr/local/bin/
    - terraform-docs --version
  script:
    - echo "Checking Terraform documentation..."
    - |
      # Check if README files are up to date for modules
      for dir in modules/*/; do
        if [ -f "$dir/main.tf" ]; then
          echo "Checking documentation for $dir"
          cd "$dir"
          if [ -f "README.md" ]; then
            # Generate docs and check if they match existing README
            terraform-docs markdown table . > README_generated.md
            if ! diff -q README.md README_generated.md > /dev/null; then
              echo "❌ Documentation is outdated in $dir"
              echo "Run 'terraform-docs markdown table . > README.md' to update"
              exit 1
            fi
            rm README_generated.md
          else
            echo "⚠️  No README.md found in $dir"
          fi
          cd - > /dev/null
        fi
      done
    - echo "✅ Terraform documentation is up to date"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.tf"
        - "**/README.md"
    - if: '$CI_COMMIT_BRANCH == "main"'
  allow_failure: true

# Combined Terraform Quality Gate
terraform-quality-gate:
  stage: validate
  image: alpine:latest
  script:
    - echo "✅ All Terraform quality checks passed!"
    - echo "Ready for merge to main branch"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.tf"
        - "**/*.tfvars"
  needs:
    - job: terraform-fmt
      optional: false
    - job: terraform-validate
      optional: true
    - job: terraform-lint
      optional: true
    - job: terraform-security
      optional: true
    - job: terraform-checkov
      optional: true

# Test documentation build
test-docs:
  extends: .setup-docs
  stage: test
  script:
    - cd docs
    - echo "Testing documentation build..."
    - mkdocs build --verbose
    - echo "Documentation builds successfully"
  rules:
    - if: '$CI_COMMIT_BRANCH == "docs"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - docs/**/*

# Build documentation
build-docs:
  extends: .setup-docs
  stage: build
  script:
    - cd docs
    - echo "Building documentation..."
    - mkdocs build --clean
    - echo "Documentation built successfully"
  artifacts:
    paths:
      - docs/site
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "docs"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - docs/**/*

# Deploy to GitLab Pages
pages:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache rsync
  script:
    - echo "Deploying documentation to GitLab Pages..."
    - mkdir -p public
    - rsync -av --delete docs/site/ public/
    - echo "Documentation deployed successfully"
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "docs"'
    - if: '$CI_COMMIT_BRANCH == "main"'
  needs:
    - build-docs
