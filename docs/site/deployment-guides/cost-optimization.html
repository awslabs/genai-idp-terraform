
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="GenAI Intelligent Document Processing for Terraform">
      
      
      
        <link rel="canonical" href="https://gitlab.aws.dev/gciupryk/genaiic-idp-accelerator-terraform/deployment-guides/cost-optimization.html">
      
      
        <link rel="prev" href="monitoring.html">
      
      
        <link rel="next" href="best-practices.html">
      
      
      <link rel="icon" href="../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Cost Optimization Guide - GenAI IDP Accelerator for Terraform</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cost-optimization-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="GenAI IDP Accelerator for Terraform" class="md-header__button md-logo" aria-label="GenAI IDP Accelerator for Terraform" data-md-component="logo">
      
  <img src="../assets/images/aws-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GenAI IDP Accelerator for Terraform
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cost Optimization Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://gitlab.aws.dev/gciupryk/genaiic-idp-accelerator-terraform" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    genaiic-idp-accelerator-terraform
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
    
  
  GenAI IDP Accelerator for Terraform

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../getting-started/index.html" class="md-tabs__link">
          
  
    
  
  Getting started

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../terraform-modules/index.html" class="md-tabs__link">
          
  
    
  
  Terraform modules

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../examples/index.html" class="md-tabs__link">
          
  
    
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="index.html" class="md-tabs__link">
          
  
    
  
  Deployment guides

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../faqs/index.html" class="md-tabs__link">
          
  
    
  
  Faqs

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../contributing/index.html" class="md-tabs__link">
          
  
    
  
  Contributing

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="GenAI IDP Accelerator for Terraform" class="md-nav__button md-logo" aria-label="GenAI IDP Accelerator for Terraform" data-md-component="logo">
      
  <img src="../assets/images/aws-logo.png" alt="logo">

    </a>
    GenAI IDP Accelerator for Terraform
  </label>
  
    <div class="md-nav__source">
      <a href="https://gitlab.aws.dev/gciupryk/genaiic-idp-accelerator-terraform" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    genaiic-idp-accelerator-terraform
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GenAI IDP Accelerator for Terraform
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../getting-started/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/prerequisites.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prerequisites
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/installation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/quick-start.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../terraform-modules/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Terraform modules
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Terraform modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../examples/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Examples
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/bedrock-llm-processor.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bedrock LLM Processor Example
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/bda-processor.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BDA Processor Example
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Deployment guides
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Deployment guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="environment-setup.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Environment Setup Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="monitoring.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring and Observability Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Cost Optimization Guide
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="cost-optimization.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Cost Optimization Guide
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cost-structure-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Structure Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cost Structure Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#primary-cost-components" class="md-nav__link">
    <span class="md-ellipsis">
      Primary Cost Components
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cost-breakdown-by-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Breakdown by Environment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-bedrock-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Amazon Bedrock Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Amazon Bedrock Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-selection-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Model Selection Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Token Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caching-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Caching Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lambda-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lambda Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#right-sizing-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Right-Sizing Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#provisioned-concurrency-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Provisioned Concurrency Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Storage Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s3-cost-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      S3 Cost Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-alerting-for-cost-control" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Alerting for Cost Control
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring and Alerting for Cost Control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cost-budgets" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Budgets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cost-anomaly-detection" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Anomaly Detection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#batch-processing-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Batch Processing Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Batch Processing Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cost-effective-batch-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Cost-Effective Batch Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduled-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduled Processing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-environment-cost-controls" class="md-nav__link">
    <span class="md-ellipsis">
      Development Environment Cost Controls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development Environment Cost Controls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resource-limits-for-development" class="md-nav__link">
    <span class="md-ellipsis">
      Resource Limits for Development
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-reporting-and-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Reporting and Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cost Reporting and Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom-cost-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Cost Dashboard
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cost-optimization-recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Optimization Recommendations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cost-optimization-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Optimization Checklist
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="best-practices.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Best Practices
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="troubleshooting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting Guide
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../faqs/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Faqs
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Faqs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../faqs/general.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General Questions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../faqs/deployment.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deployment Questions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../faqs/cost.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cost Questions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../faqs/troubleshooting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting Questions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../contributing/index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Contributing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/development.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development Guide
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cost-structure-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Structure Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cost Structure Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#primary-cost-components" class="md-nav__link">
    <span class="md-ellipsis">
      Primary Cost Components
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cost-breakdown-by-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Breakdown by Environment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amazon-bedrock-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Amazon Bedrock Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Amazon Bedrock Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-selection-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Model Selection Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Token Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caching-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Caching Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lambda-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lambda Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#right-sizing-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Right-Sizing Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#provisioned-concurrency-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Provisioned Concurrency Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Storage Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Storage Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s3-cost-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      S3 Cost Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-alerting-for-cost-control" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Alerting for Cost Control
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring and Alerting for Cost Control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cost-budgets" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Budgets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cost-anomaly-detection" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Anomaly Detection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#batch-processing-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Batch Processing Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Batch Processing Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cost-effective-batch-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Cost-Effective Batch Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduled-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduled Processing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-environment-cost-controls" class="md-nav__link">
    <span class="md-ellipsis">
      Development Environment Cost Controls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development Environment Cost Controls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resource-limits-for-development" class="md-nav__link">
    <span class="md-ellipsis">
      Resource Limits for Development
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-reporting-and-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Reporting and Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cost Reporting and Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom-cost-dashboard" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Cost Dashboard
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cost-optimization-recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Optimization Recommendations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cost-optimization-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Cost Optimization Checklist
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="cost-optimization-guide">Cost Optimization Guide</h1>
<p>This guide provides strategies and best practices for optimizing costs when running the GenAI IDP Accelerator.</p>
<h2 id="cost-structure-overview">Cost Structure Overview</h2>
<h3 id="primary-cost-components">Primary Cost Components</h3>
<ol>
<li><strong>Amazon Bedrock</strong>: AI model inference costs (typically 40-60% of total)</li>
<li><strong>AWS Lambda</strong>: Compute costs for processing functions (15-25%)</li>
<li><strong>Amazon S3</strong>: Storage costs for documents and results (10-20%)</li>
<li><strong>Amazon Textract</strong>: Document analysis costs (10-15%)</li>
<li><strong>Amazon DynamoDB</strong>: Metadata storage costs (5-10%)</li>
<li><strong>Data Transfer</strong>: Network costs (2-5%)</li>
</ol>
<h3 id="cost-breakdown-by-environment">Cost Breakdown by Environment</h3>
<pre class="mermaid"><code>pie title Cost Distribution by Service
    "Amazon Bedrock" : 50
    "AWS Lambda" : 20
    "Amazon S3" : 15
    "Amazon Textract" : 10
    "Other Services" : 5</code></pre>
<h2 id="amazon-bedrock-optimization">Amazon Bedrock Optimization</h2>
<h3 id="model-selection-strategy">Model Selection Strategy</h3>
<p><strong>Cost-Performance Matrix</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># Variable model configuration based on use case</span>
<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;bedrock_model_config&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Bedrock model configuration by use case&quot;</span>
<span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">object</span><span class="p">({</span>
<span class="w">    </span><span class="na">model_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="na">max_tokens</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<span class="w">    </span><span class="na">cost_per_1k</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<span class="w">    </span><span class="na">use_case</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">}))</span>

<span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;simple_extraction&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">model_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;amazon.titan-text-lite-v1&quot;</span>
<span class="w">      </span><span class="na">max_tokens</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">500</span>
<span class="w">      </span><span class="na">cost_per_1k</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">0.0003</span>
<span class="w">      </span><span class="na">use_case</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Basic text extraction and simple classification&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="s2">&quot;complex_analysis&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">model_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anthropic.claude-3-haiku-20240307-v1:0&quot;</span>
<span class="w">      </span><span class="na">max_tokens</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span>
<span class="w">      </span><span class="na">cost_per_1k</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">0.00025</span>
<span class="w">      </span><span class="na">use_case</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Complex document analysis and reasoning&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="s2">&quot;premium_processing&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">model_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anthropic.claude-3-sonnet-20240229-v1:0&quot;</span>
<span class="w">      </span><span class="na">max_tokens</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">2000</span>
<span class="w">      </span><span class="na">cost_per_1k</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">0.003</span>
<span class="w">      </span><span class="na">use_case</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;High-accuracy processing for critical documents&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Dynamic model selection based on document type</span>
<span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">model_selection_logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;invoice&quot;</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.bedrock_model_config</span><span class="p">[</span><span class="s2">&quot;simple_extraction&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="s2">&quot;contract&quot;</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.bedrock_model_config</span><span class="p">[</span><span class="s2">&quot;complex_analysis&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="s2">&quot;legal_doc&quot;</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.bedrock_model_config</span><span class="p">[</span><span class="s2">&quot;premium_processing&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="s2">&quot;default&quot;</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.bedrock_model_config</span><span class="p">[</span><span class="s2">&quot;simple_extraction&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<h3 id="token-optimization">Token Optimization</h3>
<p><strong>Prompt Engineering for Cost Efficiency</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># Cost-optimized prompt templates</span>
<span class="n">COST_OPTIMIZED_PROMPTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;invoice_extraction&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;Extract key data from this invoice:</span>
<span class="s2">- Invoice number</span>
<span class="s2">- Date</span>
<span class="s2">- Total amount</span>
<span class="s2">- Vendor name</span>

<span class="s2">Text: </span><span class="si">{document_text}</span>

<span class="s2">Format as JSON.&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s2">&quot;estimated_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;$0.00006&quot;</span>
    <span class="p">},</span>

    <span class="s2">&quot;contract_analysis&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;Analyze contract for:</span>
<span class="s2">1. Key terms</span>
<span class="s2">2. Dates</span>
<span class="s2">3. Parties involved</span>
<span class="s2">4. Financial obligations</span>

<span class="s2">Text: </span><span class="si">{document_text}</span>

<span class="s2">Provide concise summary.&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s2">&quot;estimated_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;$0.00015&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">optimize_prompt_for_cost</span><span class="p">(</span><span class="n">document_type</span><span class="p">,</span> <span class="n">document_text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select cost-optimized prompt based on document type&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">COST_OPTIMIZED_PROMPTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">document_type</span><span class="p">,</span> <span class="n">COST_OPTIMIZED_PROMPTS</span><span class="p">[</span><span class="s2">&quot;invoice_extraction&quot;</span><span class="p">])</span>

    <span class="c1"># Truncate input if too long</span>
    <span class="n">max_input_tokens</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Adjust based on model limits</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">document_text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">max_input_tokens</span><span class="p">:</span>
        <span class="n">document_text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">document_text</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="n">max_input_tokens</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">document_text</span><span class="o">=</span><span class="n">document_text</span><span class="p">),</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;max_tokens&quot;</span><span class="p">]</span>
</code></pre></div></p>
<h3 id="caching-strategy">Caching Strategy</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># DynamoDB table for caching Bedrock responses</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_dynamodb_table&quot;</span><span class="w"> </span><span class="nv">&quot;bedrock_cache&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-bedrock-cache&quot;</span>
<span class="w">  </span><span class="na">billing_mode</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PAY_PER_REQUEST&quot;</span>
<span class="w">  </span><span class="na">hash_key</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;content_hash&quot;</span>

<span class="w">  </span><span class="nb">attribute</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;content_hash&quot;</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">ttl</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">attribute_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;expires_at&quot;</span>
<span class="w">    </span><span class="na">enabled</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="nv">local.common_tags</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Purpose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Cost optimization through response caching&quot;</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">def</span> <span class="nf">get_content_hash</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate hash for caching purposes&quot;&quot;&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">check_bedrock_cache</span><span class="p">(</span><span class="n">content_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if response is cached&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
            <span class="n">TableName</span><span class="o">=</span><span class="n">CACHE_TABLE_NAME</span><span class="p">,</span>
            <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;content_hash&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">content_hash</span><span class="p">}}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;Item&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="c1"># Check if not expired</span>
            <span class="n">expires_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">][</span><span class="s1">&#39;expires_at&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">expires_at</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()):</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">][</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;S&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache check failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">cache_bedrock_response</span><span class="p">(</span><span class="n">content_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ttl_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cache Bedrock response&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expires_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">ttl_hours</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>

        <span class="n">dynamodb</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
            <span class="n">TableName</span><span class="o">=</span><span class="n">CACHE_TABLE_NAME</span><span class="p">,</span>
            <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;content_hash&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">content_hash</span><span class="p">},</span>
                <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)},</span>
                <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">expires_at</span><span class="p">)},</span>
                <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))}</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache write failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="lambda-optimization">Lambda Optimization</h2>
<h3 id="right-sizing-functions">Right-Sizing Functions</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Environment-specific Lambda configurations</span>
<span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">lambda_configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">512</span>
<span class="w">      </span><span class="na">timeout</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span>
<span class="w">      </span><span class="na">reserved_concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">staging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1024</span>
<span class="w">      </span><span class="na">timeout</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">300</span>
<span class="w">      </span><span class="na">reserved_concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2048</span>
<span class="w">      </span><span class="na">timeout</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">900</span>
<span class="w">      </span><span class="na">reserved_concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">current_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.lambda_configs[var.environment</span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_function&quot;</span><span class="w"> </span><span class="nv">&quot;document_processor&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-document-processor&quot;</span>

<span class="c1">  # Optimized configuration</span>
<span class="w">  </span><span class="na">memory_size</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="nv">local.current_config.memory_size</span>
<span class="w">  </span><span class="na">timeout</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="nv">local.current_config.timeout</span>
<span class="w">  </span><span class="na">reserved_concurrent_executions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.current_config.reserved_concurrency</span>

<span class="c1">  # Cost optimization settings</span>
<span class="w">  </span><span class="nb">dead_letter_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">target_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_sqs_queue.dlq.arn</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">environment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">POWERTOOLS_LOG_LEVEL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot; ? &quot;INFO&quot; : &quot;DEBUG&quot;</span>
<span class="w">      </span><span class="na">ENABLE_DETAILED_LOGGING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;dev&quot; ? &quot;true&quot; : &quot;false&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="nv">local.common_tags</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">CostOptimization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;enabled&quot;</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="provisioned-concurrency-optimization">Provisioned Concurrency Optimization</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Conditional provisioned concurrency for production</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_provisioned_concurrency_config&quot;</span><span class="w"> </span><span class="nv">&quot;document_processor&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span><span class="nv">var.enable_provisioned_concurrency</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="na">function_name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lambda_function.document_processor.function_name</span>
<span class="w">  </span><span class="na">provisioned_concurrent_executions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.provisioned_concurrency_count</span>
<span class="w">  </span><span class="na">qualifier</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lambda_function.document_processor.version</span>
<span class="p">}</span>

<span class="c1"># Auto-scaling for provisioned concurrency</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_appautoscaling_target&quot;</span><span class="w"> </span><span class="nv">&quot;lambda_concurrency&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span><span class="nv">var.enable_provisioned_concurrency</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="na">max_capacity</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.max_provisioned_concurrency</span>
<span class="w">  </span><span class="na">min_capacity</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.min_provisioned_concurrency</span>
<span class="w">  </span><span class="na">resource_id</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;function:${aws_lambda_function.document_processor.function_name}:provisioned&quot;</span>
<span class="w">  </span><span class="na">scalable_dimension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda:function:ProvisionedConcurrency&quot;</span>
<span class="w">  </span><span class="na">service_namespace</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_appautoscaling_policy&quot;</span><span class="w"> </span><span class="nv">&quot;lambda_concurrency_policy&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span><span class="nv">var.enable_provisioned_concurrency</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="na">name</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-lambda-concurrency-policy&quot;</span>
<span class="w">  </span><span class="na">policy_type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;TargetTrackingScaling&quot;</span>
<span class="w">  </span><span class="na">resource_id</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_appautoscaling_target.lambda_concurrency[0].resource_id</span>
<span class="w">  </span><span class="na">scalable_dimension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_appautoscaling_target.lambda_concurrency[0].scalable_dimension</span>
<span class="w">  </span><span class="na">service_namespace</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_appautoscaling_target.lambda_concurrency[0].service_namespace</span>

<span class="w">  </span><span class="nb">target_tracking_scaling_policy_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">target_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">70.0</span>

<span class="w">    </span><span class="nb">predefined_metric_specification</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">predefined_metric_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;LambdaProvisionedConcurrencyUtilization&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="storage-optimization">Storage Optimization</h2>
<h3 id="s3-cost-optimization">S3 Cost Optimization</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Intelligent tiering and lifecycle policies</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_lifecycle_configuration&quot;</span><span class="w"> </span><span class="nv">&quot;documents_lifecycle&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.documents.id</span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cost_optimization&quot;</span>
<span class="w">    </span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span>

<span class="c1">    # Transition to IA after 30 days</span>
<span class="w">    </span><span class="nb">transition</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">days</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="m">30</span>
<span class="w">      </span><span class="na">storage_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;STANDARD_IA&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">    # Transition to Glacier after 90 days</span>
<span class="w">    </span><span class="nb">transition</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">days</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="m">90</span>
<span class="w">      </span><span class="na">storage_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GLACIER&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">    # Transition to Deep Archive after 365 days</span>
<span class="w">    </span><span class="nb">transition</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">days</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="m">365</span>
<span class="w">      </span><span class="na">storage_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DEEP_ARCHIVE&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">    # Delete incomplete multipart uploads</span>
<span class="w">    </span><span class="nb">abort_incomplete_multipart_upload</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">days_after_initiation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">    # Delete old versions</span>
<span class="w">    </span><span class="nb">noncurrent_version_transition</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">noncurrent_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span>
<span class="w">      </span><span class="na">storage_class</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;STANDARD_IA&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">noncurrent_version_expiration</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">noncurrent_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">90</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">rule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;processed_documents_cleanup&quot;</span>
<span class="w">    </span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span>

<span class="w">    </span><span class="nb">filter</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;processed/&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="c1">    # Delete processed documents after retention period</span>
<span class="w">    </span><span class="nb">expiration</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.processed_document_retention_days</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Intelligent tiering for automatic cost optimization</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_s3_bucket_intelligent_tiering_configuration&quot;</span><span class="w"> </span><span class="nv">&quot;documents_intelligent_tiering&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_s3_bucket.documents.id</span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;EntireBucket&quot;</span>

<span class="w">  </span><span class="nb">tiering</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">access_tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ARCHIVE_ACCESS&quot;</span>
<span class="w">    </span><span class="na">days</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">90</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">tiering</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">access_tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DEEP_ARCHIVE_ACCESS&quot;</span>
<span class="w">    </span><span class="na">days</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="m">180</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="dynamodb-optimization">DynamoDB Optimization</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># On-demand billing for variable workloads</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_dynamodb_table&quot;</span><span class="w"> </span><span class="nv">&quot;document_metadata&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-document-metadata&quot;</span>
<span class="w">  </span><span class="na">billing_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot; ? &quot;PROVISIONED&quot; : &quot;PAY_PER_REQUEST&quot;</span>

<span class="c1">  # Provisioned capacity for production (with auto-scaling)</span>
<span class="w">  </span><span class="na">read_capacity</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="nv">var.dynamodb_read_capacity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">null</span>
<span class="w">  </span><span class="na">write_capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="nv">var.dynamodb_write_capacity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">null</span>

<span class="w">  </span><span class="na">hash_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;document_id&quot;</span>

<span class="w">  </span><span class="nb">attribute</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;document_id&quot;</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">attribute</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;status&quot;</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">attribute</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;created_at&quot;</span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # GSI for status queries</span>
<span class="w">  </span><span class="nb">global_secondary_index</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;status-created-index&quot;</span>
<span class="w">    </span><span class="na">hash_key</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;status&quot;</span>
<span class="w">    </span><span class="na">range_key</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;created_at&quot;</span>
<span class="w">    </span><span class="na">projection_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;KEYS_ONLY&quot;</span>

<span class="w">    </span><span class="na">read_capacity</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="nv">var.dynamodb_gsi_read_capacity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">null</span>
<span class="w">    </span><span class="na">write_capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="nv">var.dynamodb_gsi_write_capacity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">null</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # TTL for automatic cleanup</span>
<span class="w">  </span><span class="nb">ttl</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">attribute_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;expires_at&quot;</span>
<span class="w">    </span><span class="na">enabled</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>
<span class="p">}</span>

<span class="c1"># Auto-scaling for production</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_appautoscaling_target&quot;</span><span class="w"> </span><span class="nv">&quot;dynamodb_table_read_target&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="na">max_capacity</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.dynamodb_max_read_capacity</span>
<span class="w">  </span><span class="na">min_capacity</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">var.dynamodb_min_read_capacity</span>
<span class="w">  </span><span class="na">resource_id</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;table/${aws_dynamodb_table.document_metadata.name}&quot;</span>
<span class="w">  </span><span class="na">scalable_dimension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dynamodb:table:ReadCapacityUnits&quot;</span>
<span class="w">  </span><span class="na">service_namespace</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dynamodb&quot;</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_appautoscaling_policy&quot;</span><span class="w"> </span><span class="nv">&quot;dynamodb_table_read_policy&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="na">name</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-dynamodb-read-policy&quot;</span>
<span class="w">  </span><span class="na">policy_type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;TargetTrackingScaling&quot;</span>
<span class="w">  </span><span class="na">resource_id</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_appautoscaling_target.dynamodb_table_read_target[0].resource_id</span>
<span class="w">  </span><span class="na">scalable_dimension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_appautoscaling_target.dynamodb_table_read_target[0].scalable_dimension</span>
<span class="w">  </span><span class="na">service_namespace</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_appautoscaling_target.dynamodb_table_read_target[0].service_namespace</span>

<span class="w">  </span><span class="nb">target_tracking_scaling_policy_configuration</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">target_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">70.0</span>

<span class="w">    </span><span class="nb">predefined_metric_specification</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">predefined_metric_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DynamoDBReadCapacityUtilization&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="monitoring-and-alerting-for-cost-control">Monitoring and Alerting for Cost Control</h2>
<h3 id="cost-budgets">Cost Budgets</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Monthly budget with alerts</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_budgets_budget&quot;</span><span class="w"> </span><span class="nv">&quot;idp_monthly_budget&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-monthly-budget&quot;</span>
<span class="w">  </span><span class="na">budget_type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;COST&quot;</span>
<span class="w">  </span><span class="na">limit_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.monthly_budget_limit</span>
<span class="w">  </span><span class="na">limit_unit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;USD&quot;</span>
<span class="w">  </span><span class="na">time_unit</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;MONTHLY&quot;</span>

<span class="w">  </span><span class="nb">cost_filters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;Environment:${var.environment}&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Project:genai-idp-accelerator&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # 80% threshold</span>
<span class="w">  </span><span class="nb">notification</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">comparison_operator</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GREATER_THAN&quot;</span>
<span class="w">    </span><span class="na">threshold</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="m">80</span>
<span class="w">    </span><span class="na">threshold_type</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PERCENTAGE&quot;</span>
<span class="w">    </span><span class="na">notification_type</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ACTUAL&quot;</span>
<span class="w">    </span><span class="na">subscriber_email_addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.budget_alert_emails</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # 100% threshold</span>
<span class="w">  </span><span class="nb">notification</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">comparison_operator</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GREATER_THAN&quot;</span>
<span class="w">    </span><span class="na">threshold</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="na">threshold_type</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PERCENTAGE&quot;</span>
<span class="w">    </span><span class="na">notification_type</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ACTUAL&quot;</span>
<span class="w">    </span><span class="na">subscriber_email_addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.budget_alert_emails</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">  # 120% forecast</span>
<span class="w">  </span><span class="nb">notification</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">comparison_operator</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GREATER_THAN&quot;</span>
<span class="w">    </span><span class="na">threshold</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="m">120</span>
<span class="w">    </span><span class="na">threshold_type</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PERCENTAGE&quot;</span>
<span class="w">    </span><span class="na">notification_type</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;FORECASTED&quot;</span>
<span class="w">    </span><span class="na">subscriber_email_addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.budget_alert_emails</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Service-specific budgets</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_budgets_budget&quot;</span><span class="w"> </span><span class="nv">&quot;bedrock_budget&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-bedrock-budget&quot;</span>
<span class="w">  </span><span class="na">budget_type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;COST&quot;</span>
<span class="w">  </span><span class="na">limit_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.bedrock_budget_limit</span>
<span class="w">  </span><span class="na">limit_unit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;USD&quot;</span>
<span class="w">  </span><span class="na">time_unit</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;MONTHLY&quot;</span>

<span class="w">  </span><span class="nb">cost_filters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Amazon Bedrock&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">Tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Environment:${var.environment}&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">notification</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">comparison_operator</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;GREATER_THAN&quot;</span>
<span class="w">    </span><span class="na">threshold</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="m">90</span>
<span class="w">    </span><span class="na">threshold_type</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PERCENTAGE&quot;</span>
<span class="w">    </span><span class="na">notification_type</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ACTUAL&quot;</span>
<span class="w">    </span><span class="na">subscriber_email_addresses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.budget_alert_emails</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="cost-anomaly-detection">Cost Anomaly Detection</h3>
<div class="highlight"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_ce_anomaly_detector&quot;</span><span class="w"> </span><span class="nv">&quot;idp_cost_anomaly&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-cost-anomaly-detector&quot;</span>
<span class="w">  </span><span class="na">monitor_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DIMENSIONAL&quot;</span>

<span class="w">  </span><span class="na">specification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Dimension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SERVICE&quot;</span>
<span class="w">    </span><span class="na">MatchOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;EQUALS&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="na">Values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;Amazon Bedrock&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;AWS Lambda&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Amazon S3&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Amazon Textract&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Amazon DynamoDB&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_ce_anomaly_subscription&quot;</span><span class="w"> </span><span class="nv">&quot;idp_cost_anomaly_subscription&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-cost-anomaly-subscription&quot;</span>
<span class="w">  </span><span class="na">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DAILY&quot;</span>

<span class="w">  </span><span class="na">monitor_arn_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_ce_anomaly_detector.idp_cost_anomaly.arn</span><span class="p">]</span>

<span class="w">  </span><span class="nb">subscriber</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;EMAIL&quot;</span>
<span class="w">    </span><span class="na">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.cost_anomaly_alert_email</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nb">threshold_expression</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">and</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">dimension</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="na">key</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ANOMALY_TOTAL_IMPACT_ABSOLUTE&quot;</span>
<span class="w">        </span><span class="na">values</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">var.cost_anomaly_threshold</span><span class="p">]</span>
<span class="w">        </span><span class="na">match_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;GREATER_THAN_OR_EQUAL&quot;</span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="batch-processing-optimization">Batch Processing Optimization</h2>
<h3 id="cost-effective-batch-processing">Cost-Effective Batch Processing</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># SQS queue for batch processing</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_sqs_queue&quot;</span><span class="w"> </span><span class="nv">&quot;batch_processing_queue&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-batch-processing&quot;</span>
<span class="w">  </span><span class="na">visibility_timeout_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">900</span><span class="c1">  # 15 minutes</span>
<span class="w">  </span><span class="na">message_retention_seconds</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1209600</span><span class="c1">  # 14 days</span>

<span class="c1">  # Cost optimization: longer polling</span>
<span class="w">  </span><span class="na">receive_wait_time_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>
<span class="p">}</span>

<span class="c1"># Lambda for batch processing (larger memory, longer timeout)</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_function&quot;</span><span class="w"> </span><span class="nv">&quot;batch_processor&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-batch-processor&quot;</span>
<span class="w">  </span><span class="na">memory_size</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">3008</span><span class="c1">  # Maximum memory for better price/performance</span>
<span class="w">  </span><span class="na">timeout</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="m">900</span><span class="c1">   # 15 minutes</span>

<span class="c1">  # Process multiple documents per invocation</span>
<span class="w">  </span><span class="nb">environment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">BATCH_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10&quot;</span>
<span class="w">      </span><span class="na">ENABLE_PARALLEL_PROCESSING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;true&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="nv">local.common_tags</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">ProcessingType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;batch&quot;</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="scheduled-processing">Scheduled Processing</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># EventBridge rule for off-peak processing</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_event_rule&quot;</span><span class="w"> </span><span class="nv">&quot;batch_processing_schedule&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-batch-processing-schedule&quot;</span>
<span class="w">  </span><span class="na">description</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Trigger batch processing during off-peak hours&quot;</span>
<span class="w">  </span><span class="na">schedule_expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cron(0 2 * * ? *)&quot;</span><span class="c1">  # 2 AM daily</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_event_target&quot;</span><span class="w"> </span><span class="nv">&quot;batch_processing_target&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">rule</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_cloudwatch_event_rule.batch_processing_schedule.name</span>
<span class="w">  </span><span class="na">target_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;BatchProcessingTarget&quot;</span>
<span class="w">  </span><span class="na">arn</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lambda_function.batch_processor.arn</span>

<span class="w">  </span><span class="na">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">processing_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;batch&quot;</span>
<span class="w">    </span><span class="na">max_documents</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="na">priority</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;low&quot;</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="development-environment-cost-controls">Development Environment Cost Controls</h2>
<h3 id="resource-limits-for-development">Resource Limits for Development</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Development environment with strict limits</span>
<span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">dev_limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">lambda_memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">512</span>
<span class="w">    </span><span class="na">lambda_timeout</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">60</span>
<span class="w">    </span><span class="na">lambda_concurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="w">    </span><span class="na">s3_lifecycle_days</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
<span class="w">    </span><span class="na">dynamodb_billing</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PAY_PER_REQUEST&quot;</span>
<span class="w">    </span><span class="na">enable_monitoring</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">    </span><span class="na">log_retention_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Conditional resource creation</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_function&quot;</span><span class="w"> </span><span class="nv">&quot;dev_document_processor&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-document-processor&quot;</span>
<span class="w">  </span><span class="na">memory_size</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">local.dev_limits.lambda_memory_size</span>
<span class="w">  </span><span class="na">timeout</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">local.dev_limits.lambda_timeout</span>

<span class="w">  </span><span class="na">reserved_concurrent_executions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.dev_limits.lambda_concurrency</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="nv">local.common_tags</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span>
<span class="w">    </span><span class="na">AutoShutdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;enabled&quot;</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="c1"># Auto-shutdown for development resources</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_event_rule&quot;</span><span class="w"> </span><span class="nv">&quot;dev_auto_shutdown&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.environment</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-auto-shutdown&quot;</span>
<span class="w">  </span><span class="na">description</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Auto-shutdown development resources&quot;</span>
<span class="w">  </span><span class="na">schedule_expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cron(0 18 * * MON-FRI *)&quot;</span><span class="c1">  # 6 PM weekdays</span>

<span class="w">  </span><span class="na">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">local.common_tags</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="cost-reporting-and-analysis">Cost Reporting and Analysis</h2>
<h3 id="custom-cost-dashboard">Custom Cost Dashboard</h3>
<div class="highlight"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_dashboard&quot;</span><span class="w"> </span><span class="nv">&quot;cost_dashboard&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">dashboard_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.environment}-idp-cost-dashboard&quot;</span>

<span class="w">  </span><span class="na">dashboard_body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">widgets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="na">type</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;metric&quot;</span>
<span class="w">        </span><span class="na">x</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="na">y</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="na">width</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">12</span>
<span class="w">        </span><span class="na">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>

<span class="w">        </span><span class="nb">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="na">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;AWS/Billing&quot;, &quot;EstimatedCharges&quot;, &quot;ServiceName&quot;, &quot;AmazonBedrock&quot;, &quot;Currency&quot;, &quot;USD&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;.&quot;, &quot;.&quot;, &quot;ServiceName&quot;, &quot;AWSLambda&quot;, &quot;.&quot;, &quot;.&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;.&quot;, &quot;.&quot;, &quot;ServiceName&quot;, &quot;AmazonS3&quot;, &quot;.&quot;, &quot;.&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;.&quot;, &quot;.&quot;, &quot;ServiceName&quot;, &quot;AmazonTextract&quot;, &quot;.&quot;, &quot;.&quot;</span><span class="p">]</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">          </span><span class="na">view</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;timeSeries&quot;</span>
<span class="w">          </span><span class="na">stacked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<span class="w">          </span><span class="na">region</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;us-east-1&quot;</span><span class="c1">  # Billing metrics are only in us-east-1</span>
<span class="w">          </span><span class="na">title</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Estimated Charges by Service&quot;</span>
<span class="w">          </span><span class="na">period</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">86400</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="cost-optimization-recommendations">Cost Optimization Recommendations</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Lambda function for cost optimization recommendations</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">def</span> <span class="nf">generate_cost_recommendations</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate cost optimization recommendations&quot;&quot;&quot;</span>

    <span class="n">ce_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ce&#39;</span><span class="p">)</span>

    <span class="c1"># Get cost data for last 30 days</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">ce_client</span><span class="o">.</span><span class="n">get_cost_and_usage</span><span class="p">(</span>
        <span class="n">TimePeriod</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Start&#39;</span><span class="p">:</span> <span class="n">start_date</span><span class="p">,</span>
            <span class="s1">&#39;End&#39;</span><span class="p">:</span> <span class="n">end_date</span>
        <span class="p">},</span>
        <span class="n">Granularity</span><span class="o">=</span><span class="s1">&#39;DAILY&#39;</span><span class="p">,</span>
        <span class="n">Metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BlendedCost&#39;</span><span class="p">],</span>
        <span class="n">GroupBy</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;DIMENSION&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;SERVICE&#39;</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="n">Filter</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;Project&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;genai-idp-accelerator&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Analyze Bedrock costs</span>
    <span class="n">bedrock_cost</span> <span class="o">=</span> <span class="n">get_service_cost</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;Amazon Bedrock&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bedrock_cost</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># $100 threshold</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="s1">&#39;Amazon Bedrock&#39;</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Consider using smaller models for simple tasks&#39;</span><span class="p">,</span>
            <span class="s1">&#39;potential_savings&#39;</span><span class="p">:</span> <span class="s1">&#39;20-40%&#39;</span>
        <span class="p">})</span>

    <span class="c1"># Analyze Lambda costs</span>
    <span class="n">lambda_cost</span> <span class="o">=</span> <span class="n">get_service_cost</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;AWS Lambda&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lambda_cost</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># $50 threshold</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="s1">&#39;AWS Lambda&#39;</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Review memory allocation and consider ARM-based functions&#39;</span><span class="p">,</span>
            <span class="s1">&#39;potential_savings&#39;</span><span class="p">:</span> <span class="s1">&#39;10-20%&#39;</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;statusCode&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="n">recommendations</span><span class="p">,</span>
            <span class="s1">&#39;generated_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">})</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">get_service_cost</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">service_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract cost for specific service&quot;&quot;&quot;</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;ResultsByTime&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Groups&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;Keys&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">service_name</span><span class="p">:</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;Metrics&#39;</span><span class="p">][</span><span class="s1">&#39;BlendedCost&#39;</span><span class="p">][</span><span class="s1">&#39;Amount&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">total_cost</span>
</code></pre></div>
<h2 id="best-practices-summary">Best Practices Summary</h2>
<h3 id="cost-optimization-checklist">Cost Optimization Checklist</h3>
<p><strong>Bedrock Optimization</strong>:
- [ ] Use appropriate model sizes for each use case
- [ ] Implement response caching
- [ ] Optimize prompts for token efficiency
- [ ] Monitor token usage patterns</p>
<p><strong>Lambda Optimization</strong>:
- [ ] Right-size memory allocation
- [ ] Use ARM-based processors when possible
- [ ] Implement proper error handling to avoid retries
- [ ] Use provisioned concurrency only when needed</p>
<p><strong>Storage Optimization</strong>:
- [ ] Implement S3 lifecycle policies
- [ ] Use intelligent tiering
- [ ] Clean up old processed documents
- [ ] Optimize DynamoDB capacity settings</p>
<p><strong>Monitoring and Alerts</strong>:
- [ ] Set up cost budgets and alerts
- [ ] Monitor cost anomalies
- [ ] Regular cost reviews and optimization
- [ ] Track cost per document processed</p>
<p><strong>Environment Management</strong>:
- [ ] Use smaller resources for development
- [ ] Implement auto-shutdown for dev environments
- [ ] Regular cleanup of unused resources
- [ ] Tag all resources for cost tracking</p>
<hr />
<p>Next: <a href="best-practices.html">Best Practices</a> | <a href="troubleshooting.html">Troubleshooting</a></p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    2025-07-08
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="monitoring.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Monitoring and Observability Guide">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Monitoring and Observability Guide
              </div>
            </div>
          </a>
        
        
          
          <a href="best-practices.html" class="md-footer__link md-footer__link--next" aria-label="Next: Best Practices">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Best Practices
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Amazon Web Services, Inc. or its affiliates.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://aws.amazon.com" target="_blank" rel="noopener" title="Amazon Web Services, Inc." class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M180.41 203.01c-.72 22.65 10.6 32.68 10.88 39.05a8.16 8.16 0 0 1-4.1 6.27l-12.8 8.96a10.66 10.66 0 0 1-5.63 1.92c-.43-.02-8.19 1.83-20.48-25.61a78.6 78.6 0 0 1-62.61 29.45c-16.28.89-60.4-9.24-58.13-56.21-1.59-38.28 34.06-62.06 70.93-60.05 7.1.02 21.6.37 46.99 6.27v-15.62c2.69-26.46-14.7-46.99-44.81-43.91-2.4.01-19.4-.5-45.84 10.11-7.36 3.38-8.3 2.82-10.75 2.82-7.41 0-4.36-21.48-2.94-24.2 5.21-6.4 35.86-18.35 65.94-18.18a76.86 76.86 0 0 1 55.69 17.28 70.29 70.29 0 0 1 17.67 52.36zM93.99 235.4c32.43-.47 46.16-19.97 49.29-30.47 2.46-10.05 2.05-16.41 2.05-27.4-9.67-2.32-23.59-4.85-39.56-4.87-15.15-1.14-42.82 5.63-41.74 32.26-1.24 16.79 11.12 31.4 29.96 30.48m170.92 23.05c-7.86.72-11.52-4.86-12.68-10.37l-49.8-164.65c-.97-2.78-1.61-5.65-1.92-8.58a4.61 4.61 0 0 1 3.86-5.25c.24-.04-2.13 0 22.25 0 8.78-.88 11.64 6.03 12.55 10.37l35.72 140.83 33.16-140.83c.53-3.22 2.94-11.07 12.8-10.24h17.16c2.17-.18 11.11-.5 12.68 10.37l33.42 142.63L420.98 80.1c.48-2.18 2.72-11.37 12.68-10.37h19.72c.85-.13 6.15-.81 5.25 8.58-.43 1.85 3.41-10.66-52.75 169.9-1.15 5.51-4.82 11.09-12.68 10.37h-18.69c-10.94 1.15-12.51-9.66-12.68-10.75L328.67 110.7l-32.78 136.99c-.16 1.09-1.73 11.9-12.68 10.75h-18.3zm273.48 5.63c-5.88.01-33.92-.3-57.36-12.29a12.8 12.8 0 0 1-7.81-11.91v-10.75c0-8.45 6.2-6.9 8.83-5.89 10.04 4.06 16.48 7.14 28.81 9.6 36.65 7.53 52.77-2.3 56.72-4.48 13.15-7.81 14.19-25.68 5.25-34.95-10.48-8.79-15.48-9.12-53.13-21-4.64-1.29-43.7-13.61-43.79-52.36-.61-28.24 25.05-56.18 69.52-55.95 12.67-.01 46.43 4.13 55.57 15.62 1.35 2.09 2.02 4.55 1.92 7.04v10.11c0 4.44-1.62 6.66-4.87 6.66-7.71-.86-21.39-11.17-49.16-10.75-6.89-.36-39.89.91-38.41 24.97-.43 18.96 26.61 26.07 29.7 26.89 36.46 10.97 48.65 12.79 63.12 29.58 17.14 22.25 7.9 48.3 4.35 55.44-19.08 37.49-68.42 34.44-69.26 34.42m40.2 104.86c-70.03 51.72-171.69 79.25-258.49 79.25A469.13 469.13 0 0 1 2.83 327.46c-6.53-5.89-.77-13.96 7.17-9.47a637.37 637.37 0 0 0 316.88 84.12 630.2 630.2 0 0 0 241.59-49.55c11.78-5 21.77 7.8 10.12 16.38m29.19-33.29c-8.96-11.52-59.28-5.38-81.81-2.69-6.79.77-7.94-5.12-1.79-9.47 40.07-28.17 105.88-20.1 113.44-10.63 7.55 9.47-2.05 75.41-39.56 106.91-5.76 4.87-11.27 2.3-8.71-4.1 8.44-21.25 27.39-68.49 18.43-80.02"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.tabs.link", "toc.follow", "navigation.path", "navigation.expand", "navigation.indexes", "navigation.instant", "navigation.tabs", "navigation.footer"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  </body>
</html>